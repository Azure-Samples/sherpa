<!--
    APIM Policy: Output Sanitization for Trail REST API
    
    This policy applies output sanitization to the trail-api REST API.
    It's used instead of trail-mcp outbound policy because synthesized MCP
    servers have SSE streams that block Body.As<string>() calls.
    
    When trail-mcp calls trail-api operations, this policy sanitizes
    the REST response BEFORE APIM wraps it in SSE.
    
    Includes:
    - Layer 2: Azure Function sanitize_output (PII redaction)
-->
<policies>
    <inbound>
        <base />
        
        <!-- W3C Trace Context Propagation for Distributed Tracing -->
        <set-header name="traceparent" exists-action="skip">
            <value>@{
                var traceId = context.RequestId.ToString("N");
                var spanId = Guid.NewGuid().ToString("N").Substring(0, 16);
                return $"00-{traceId}-{spanId}-01";
            }</value>
        </set-header>
        <set-header name="tracestate" exists-action="skip">
            <value>@($"apim={context.Deployment.ServiceName}")</value>
        </set-header>
    </inbound>
    <backend>
        <forward-request />
    </backend>
    <outbound>
        <base />
        <!-- Output Sanitization (Azure Function) - applied at REST API level -->
        <send-request mode="new" response-variable-name="sanitized" timeout="10" ignore-error="true">
            <set-url>{{function-app-url}}/api/sanitize-output</set-url>
            <set-method>POST</set-method>
            <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
            </set-header>
            <!-- Pass APIM's correlation ID for cross-service log tracing -->
            <set-header name="x-correlation-id" exists-action="override">
                <value>@(context.RequestId.ToString())</value>
            </set-header>
            <set-body>@(context.Response.Body.As<string>(preserveContent: true))</set-body>
        </send-request>
        <!-- Use sanitized response if function call succeeded -->
        <choose>
            <when condition="@(context.Variables.ContainsKey("sanitized") && ((IResponse)context.Variables["sanitized"]).StatusCode == 200)">
                <set-body>@(((IResponse)context.Variables["sanitized"]).Body.As<string>())</set-body>
            </when>
            <!-- On sanitization failure, pass through original (fail open for availability) -->
        </choose>
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>
