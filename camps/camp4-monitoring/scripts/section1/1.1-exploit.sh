#!/bin/bash
# =============================================================================
# Camp 4 - Section 1.1: Demonstrate APIM Logging Gap
# =============================================================================
# Pattern: hidden → visible → actionable
# Current state: HIDDEN (APIM diagnostic settings not configured)
#
# This script sends attacks through APIM and shows that while the security
# function blocks them, APIM itself has no record of MCP traffic details.
# Without diagnostic settings, ApiManagementGatewayLogs and 
# ApiManagementGatewayMCPLog remain empty.
# =============================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo ""
echo -e "${CYAN}================================================================${NC}"
echo -e "${CYAN}  Camp 4 - Section 1: APIM Logging Gap${NC}"
echo -e "${CYAN}  Pattern: hidden → visible → actionable${NC}"
echo -e "${CYAN}  Current State: HIDDEN${NC}"
echo -e "${CYAN}================================================================${NC}"
echo ""

# Load environment
APIM_GATEWAY_URL=$(azd env get-value APIM_GATEWAY_URL 2>/dev/null)
WORKSPACE_ID=$(azd env get-value LOG_ANALYTICS_WORKSPACE_ID 2>/dev/null)
RG_NAME=$(azd env get-value AZURE_RESOURCE_GROUP 2>/dev/null)
APIM_NAME=$(azd env get-value APIM_NAME 2>/dev/null)

if [ -z "$APIM_GATEWAY_URL" ]; then
    echo -e "${RED}Error: APIM_GATEWAY_URL not found. Run 'azd provision' first.${NC}"
    exit 1
fi

echo -e "${YELLOW}What we're about to demonstrate:${NC}"
echo "1. Send MCP requests through APIM (including attacks)"
echo "2. Security function will block the attacks (it's working!)"
echo "3. But APIM has NO detailed logs of these MCP transactions"
echo ""
echo -e "${YELLOW}Why this matters:${NC}"
echo "• You can't see WHO made requests (no caller IP)"
echo "• You can't see WHAT tools were called (no tool name)"
echo "• You can't correlate requests across services"
echo "• You can't build dashboards or alerts"
echo ""
echo -e "${BLUE}Step 1: Sending legitimate MCP request...${NC}"

# Send a legitimate request
LEGITIMATE_RESPONSE=$(curl -s -X POST "${APIM_GATEWAY_URL}/mcp/messages" \
    -H "Content-Type: application/json" \
    -d '{
        "jsonrpc": "2.0",
        "id": 1,
        "method": "tools/call",
        "params": {
            "name": "list-trails",
            "arguments": {}
        }
    }' 2>&1) || true

echo "Response received (truncated): ${LEGITIMATE_RESPONSE:0:100}..."
echo ""

echo -e "${BLUE}Step 2: Sending SQL injection attack...${NC}"

# Send an attack that should be blocked
ATTACK_RESPONSE=$(curl -s -X POST "${APIM_GATEWAY_URL}/mcp/messages" \
    -H "Content-Type: application/json" \
    -d '{
        "jsonrpc": "2.0",
        "id": 2,
        "method": "tools/call",
        "params": {
            "name": "search-trails",
            "arguments": {
                "query": "'; DROP TABLE users; --"
            }
        }
    }' 2>&1) || true

echo "Response: $ATTACK_RESPONSE"
echo ""

echo -e "${BLUE}Step 3: Sending path traversal attack...${NC}"

TRAVERSAL_RESPONSE=$(curl -s -X POST "${APIM_GATEWAY_URL}/mcp/messages" \
    -H "Content-Type: application/json" \
    -d '{
        "jsonrpc": "2.0",
        "id": 3,
        "method": "tools/call",
        "params": {
            "name": "read-file",
            "arguments": {
                "path": "../../../etc/passwd"
            }
        }
    }' 2>&1) || true

echo "Response: $TRAVERSAL_RESPONSE"
echo ""

# Now check if APIM has any logs
echo -e "${CYAN}================================================================${NC}"
echo -e "${CYAN}  Checking APIM Diagnostic Logs${NC}"
echo -e "${CYAN}================================================================${NC}"
echo ""

# Check diagnostic settings
echo -e "${BLUE}Checking APIM diagnostic settings...${NC}"
DIAG_SETTINGS=$(az monitor diagnostic-settings list \
    --resource "$APIM_NAME" \
    --resource-group "$RG_NAME" \
    --resource-type "Microsoft.ApiManagement/service" \
    --query "[].name" -o tsv 2>/dev/null) || true

if [ -z "$DIAG_SETTINGS" ]; then
    echo -e "${RED}✗ No diagnostic settings configured!${NC}"
    echo ""
    echo "  APIM is processing requests but logging NOTHING to Log Analytics."
    echo "  ApiManagementGatewayLogs: EMPTY"
    echo "  ApiManagementGatewayMCPLog: EMPTY"
else
    echo -e "${GREEN}✓ Diagnostic settings found: $DIAG_SETTINGS${NC}"
    echo "  (You may have already run the fix script)"
fi

echo ""
echo -e "${CYAN}================================================================${NC}"
echo -e "${CYAN}  KQL Query (will return nothing without diagnostics)${NC}"
echo -e "${CYAN}================================================================${NC}"
echo ""
echo "Try this query in Log Analytics - it will return 0 results:"
echo ""
echo -e "${YELLOW}  ApiManagementGatewayLogs"
echo "  | where TimeGenerated > ago(1h)"
echo "  | where ApiId contains 'mcp'"
echo "  | project TimeGenerated, CallerIpAddress, Method, Url, ResponseCode"
echo -e "  | limit 10${NC}"
echo ""

echo -e "${CYAN}================================================================${NC}"
echo -e "${CYAN}  The Problem: Security is HIDDEN${NC}"
echo -e "${CYAN}================================================================${NC}"
echo ""
echo "The security function blocked 2 attacks, but:"
echo ""
echo -e "  ${RED}✗${NC} APIM has no record of these requests"
echo -e "  ${RED}✗${NC} You can't see attacker IPs"
echo -e "  ${RED}✗${NC} You can't see which tools are being targeted"
echo -e "  ${RED}✗${NC} You can't correlate across services"
echo -e "  ${RED}✗${NC} You can't build dashboards or set up alerts"
echo ""
echo -e "${GREEN}Next: Run ./scripts/1.2-fix.sh to enable APIM diagnostics${NC}"
echo ""
