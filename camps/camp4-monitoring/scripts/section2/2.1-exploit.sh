#!/bin/bash
# =============================================================================
# Camp 4 - Section 2.1: Demonstrate Function Logging Gap
# =============================================================================
# Pattern: hidden → visible → actionable
# Current state: HIDDEN (function has basic logging only)
#
# The security function (v1) uses basic Python logging:
#   logging.warning(f"Injection blocked: {category}")
#
# This works, but you can't:
# - Query logs by injection type
# - Correlate with APIM requests
# - Build dashboards or alerts
# - Investigate security incidents effectively
# =============================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/../.."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo ""
echo -e "${CYAN}================================================================${NC}"
echo -e "${CYAN}  Camp 4 - Section 2.1: Function Logging Gap${NC}"
echo -e "${CYAN}  Pattern: hidden → visible → actionable${NC}"
echo -e "${CYAN}  Current State: HIDDEN${NC}"
echo -e "${CYAN}================================================================${NC}"
echo ""

# Load environment
APIM_GATEWAY_URL=$(azd env get-value APIM_GATEWAY_URL 2>/dev/null)
FUNCTION_APP_NAME=$(azd env get-value FUNCTION_APP_NAME 2>/dev/null)
RG_NAME=$(azd env get-value AZURE_RESOURCE_GROUP 2>/dev/null)
MCP_APP_CLIENT_ID=$(azd env get-value MCP_APP_CLIENT_ID 2>/dev/null)

# Get workspace GUID (az monitor log-analytics query needs GUID, not resource ID)
WORKSPACE_ID=$(az monitor log-analytics workspace list -g "$RG_NAME" --query "[0].customerId" -o tsv 2>/dev/null)

if [ -z "$APIM_GATEWAY_URL" ]; then
    echo -e "${RED}Error: APIM_GATEWAY_URL not found. Run 'azd up' first.${NC}"
    exit 1
fi

if [ -z "$MCP_APP_CLIENT_ID" ]; then
    echo -e "${RED}Error: MCP_APP_CLIENT_ID not found. Run 'azd up' first.${NC}"
    exit 1
fi

# Get OAuth token
echo -e "${BLUE}Getting OAuth token...${NC}"
TOKEN=$(az account get-access-token --resource "$MCP_APP_CLIENT_ID" --query accessToken -o tsv)
if [ -z "$TOKEN" ]; then
    echo -e "${RED}Error: Could not get access token.${NC}"
    exit 1
fi
echo -e "${GREEN}✓ OAuth token acquired${NC}"
echo ""

echo -e "${YELLOW}Current state: Security function v1 with BASIC logging${NC}"
echo ""
echo "The deployed function uses logging.warning():"
echo ""
echo -e "${BLUE}  # What v1 does:${NC}"
echo "  logging.warning(f'Injection blocked: {category}')"
echo ""
echo "This logs a simple string. Let's trigger some security events"
echo "and see what we get in the logs..."
echo ""

echo -e "${BLUE}Step 1: Triggering security events through APIM...${NC}"
echo ""

# Initialize MCP session
curl -s -D /tmp/mcp-headers.txt --max-time 10 -X POST "${APIM_GATEWAY_URL}/sherpa/mcp" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -H "Accept: application/json, text/event-stream" \
    -d '{"jsonrpc":"2.0","method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"camp4-test","version":"1.0"}},"id":1}' > /dev/null 2>&1 || true

SESSION_ID=$(grep -i "mcp-session-id" /tmp/mcp-headers.txt 2>/dev/null | sed 's/.*: *//' | tr -d '\r\n') || true
[ -z "$SESSION_ID" ] && SESSION_ID="session-$(date +%s)"

# Send various attacks to generate security events
echo "Sending SQL injection..."
curl -s --max-time 10 -X POST "${APIM_GATEWAY_URL}/sherpa/mcp" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -H "Accept: application/json, text/event-stream" \
    -H "Mcp-Session-Id: $SESSION_ID" \
    -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get_weather","arguments":{"location":"'"'"'; DROP TABLE users; --"}},"id":2}' > /dev/null 2>&1 || true

echo "Sending path traversal..."
curl -s --max-time 10 -X POST "${APIM_GATEWAY_URL}/sherpa/mcp" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -H "Accept: application/json, text/event-stream" \
    -H "Mcp-Session-Id: $SESSION_ID" \
    -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"check_trail_conditions","arguments":{"trail_id":"../../../etc/passwd"}},"id":3}' > /dev/null 2>&1 || true

echo "Sending shell injection..."
curl -s --max-time 10 -X POST "${APIM_GATEWAY_URL}/sherpa/mcp" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -H "Accept: application/json, text/event-stream" \
    -H "Mcp-Session-Id: $SESSION_ID" \
    -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get_weather","arguments":{"location":"summit; cat /etc/passwd"}},"id":4}' > /dev/null 2>&1 || true

echo ""
echo -e "${GREEN}✓ Security events triggered${NC}"
echo ""

echo -e "${BLUE}Step 2: Checking function logs...${NC}"
echo ""

# Try to query function logs - with v1 basic logging, AppTraces may not exist
# or may only contain unstructured messages that are hard to query
QUERY='AppTraces
| where TimeGenerated > ago(15m)
| where Message has "Injection" or Message has "blocked" or Message has "security"
| project TimeGenerated, Message, SeverityLevel
| order by TimeGenerated desc
| limit 10'

echo "Attempting to query structured logs (AppTraces)..."
echo ""

# Temporarily disable exit-on-error for the query (it fails if table doesn't exist)
set +e
RESULT=$(az monitor log-analytics query \
    --workspace "$WORKSPACE_ID" \
    --analytics-query "$QUERY" \
    --output json 2>&1)
QUERY_EXIT_CODE=$?
set -e

# Check if query failed (table doesn't exist) or returned empty
QUERY_FAILED=$(echo "$RESULT" | grep -c "PathNotFoundError\|does not exist" || true)

echo -e "${CYAN}================================================================${NC}"
echo -e "${CYAN}  Function Log Output (Basic Logging)${NC}"
echo -e "${CYAN}================================================================${NC}"
echo ""

if [ "$QUERY_FAILED" -gt 0 ]; then
    echo -e "${RED}  AppTraces table does not exist!${NC}"
    echo ""
    echo "  With basic Python logging (logging.warning()):"
    echo "  - Logs go to the function's console output"
    echo "  - They may appear in Azure Portal under Function > Monitor"
    echo "  - But they're NOT in a structured, queryable format"
    echo ""
    echo "  This is exactly the problem: security events are happening"
    echo "  but you can't search, aggregate, or alert on them effectively."
elif [ "$(echo "$RESULT" | jq 'length' 2>/dev/null)" -gt 0 ] 2>/dev/null; then
    echo "Here's what basic logging looks like:"
    echo ""
    echo "$RESULT" | jq -r '.[] | "  [\(.SeverityLevel)] \(.Message)"' 2>/dev/null | head -10
else
    echo "  (Logs not yet ingested - check back in 2-5 minutes)"
    echo ""
    echo "  Expected to see something like:"
    echo "    [2] Injection blocked: sql_injection"
    echo "    [2] Injection blocked: path_traversal"
    echo "    [2] Injection blocked: shell_injection"
fi

echo ""
echo -e "${GREEN}Next: Run ./scripts/section2/2.2-fix.sh to deploy structured logging${NC}"
echo ""
