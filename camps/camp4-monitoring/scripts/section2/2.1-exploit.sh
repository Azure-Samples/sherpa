#!/bin/bash
# =============================================================================
# Camp 4 - Section 2.1: Demonstrate Function Logging Gap
# =============================================================================
# Pattern: hidden → visible → actionable
# Current state: HIDDEN (function has basic logging only)
#
# The security function (v1) uses basic Python logging:
#   logging.warning(f"Injection blocked: {category}")
#
# This works, but you can't:
# - Query logs by injection type
# - Correlate with APIM requests
# - Build dashboards or alerts
# - Investigate security incidents effectively
# =============================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/../.."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo ""
echo -e "${CYAN}================================================================${NC}"
echo -e "${CYAN}  Camp 4 - Section 2.1: Function Logging Gap${NC}"
echo -e "${CYAN}  Pattern: hidden → visible → actionable${NC}"
echo -e "${CYAN}  Current State: HIDDEN${NC}"
echo -e "${CYAN}================================================================${NC}"
echo ""

# Load environment
APIM_GATEWAY_URL=$(azd env get-value APIM_GATEWAY_URL 2>/dev/null)
FUNCTION_APP_NAME=$(azd env get-value FUNCTION_APP_NAME 2>/dev/null)
WORKSPACE_ID=$(azd env get-value LOG_ANALYTICS_WORKSPACE_ID 2>/dev/null)
MCP_APP_CLIENT_ID=$(azd env get-value MCP_APP_CLIENT_ID 2>/dev/null)

if [ -z "$APIM_GATEWAY_URL" ]; then
    echo -e "${RED}Error: APIM_GATEWAY_URL not found. Run 'azd up' first.${NC}"
    exit 1
fi

if [ -z "$MCP_APP_CLIENT_ID" ]; then
    echo -e "${RED}Error: MCP_APP_CLIENT_ID not found. Run 'azd up' first.${NC}"
    exit 1
fi

# Get OAuth token
echo -e "${BLUE}Getting OAuth token...${NC}"
TOKEN=$(az account get-access-token --resource "$MCP_APP_CLIENT_ID" --query accessToken -o tsv)
if [ -z "$TOKEN" ]; then
    echo -e "${RED}Error: Could not get access token.${NC}"
    exit 1
fi
echo -e "${GREEN}✓ OAuth token acquired${NC}"
echo ""

echo -e "${YELLOW}Current state: Security function v1 with BASIC logging${NC}"
echo ""
echo "The deployed function uses logging.warning():"
echo ""
echo -e "${BLUE}  # What v1 does:${NC}"
echo "  logging.warning(f'Injection blocked: {category}')"
echo ""
echo "This logs a simple string. Let's trigger some security events"
echo "and see what we get in the logs..."
echo ""

echo -e "${BLUE}Step 1: Triggering security events through APIM...${NC}"
echo ""

# Initialize MCP session
curl -s -D /tmp/mcp-headers.txt --max-time 10 -X POST "${APIM_GATEWAY_URL}/sherpa/mcp" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -H "Accept: application/json, text/event-stream" \
    -d '{"jsonrpc":"2.0","method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"camp4-test","version":"1.0"}},"id":1}' > /dev/null 2>&1 || true

SESSION_ID=$(grep -i "mcp-session-id" /tmp/mcp-headers.txt 2>/dev/null | sed 's/.*: *//' | tr -d '\r\n') || true
[ -z "$SESSION_ID" ] && SESSION_ID="session-$(date +%s)"

# Send various attacks to generate security events
echo "Sending SQL injection..."
curl -s --max-time 10 -X POST "${APIM_GATEWAY_URL}/sherpa/mcp" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -H "Accept: application/json, text/event-stream" \
    -H "Mcp-Session-Id: $SESSION_ID" \
    -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get_weather","arguments":{"location":"'"'"'; DROP TABLE users; --"}},"id":2}' > /dev/null 2>&1 || true

echo "Sending path traversal..."
curl -s --max-time 10 -X POST "${APIM_GATEWAY_URL}/sherpa/mcp" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -H "Accept: application/json, text/event-stream" \
    -H "Mcp-Session-Id: $SESSION_ID" \
    -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"check_trail_conditions","arguments":{"trail_id":"../../../etc/passwd"}},"id":3}' > /dev/null 2>&1 || true

echo "Sending shell injection..."
curl -s --max-time 10 -X POST "${APIM_GATEWAY_URL}/sherpa/mcp" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -H "Accept: application/json, text/event-stream" \
    -H "Mcp-Session-Id: $SESSION_ID" \
    -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get_weather","arguments":{"location":"summit; cat /etc/passwd"}},"id":4}' > /dev/null 2>&1 || true

echo ""
echo -e "${GREEN}✓ Security events triggered${NC}"
echo ""

echo -e "${BLUE}Step 2: Checking function logs...${NC}"
echo ""

# Query function logs
QUERY='AppTraces
| where TimeGenerated > ago(15m)
| where AppRoleName contains "security-function" or Properties has "security"
| where SeverityLevel >= 2
| project TimeGenerated, Message, SeverityLevel
| order by TimeGenerated desc
| limit 10'

echo "Running KQL query on function logs..."
echo ""

RESULT=$(az monitor log-analytics query \
    --workspace "$WORKSPACE_ID" \
    --analytics-query "$QUERY" \
    --output json 2>/dev/null) || RESULT="[]"

echo -e "${CYAN}================================================================${NC}"
echo -e "${CYAN}  Function Log Output (Basic Logging)${NC}"
echo -e "${CYAN}================================================================${NC}"
echo ""

if [ "$(echo "$RESULT" | jq 'length' 2>/dev/null)" -gt 0 ]; then
    echo "Here's what basic logging looks like:"
    echo ""
    echo "$RESULT" | jq -r '.[] | "  [\(.SeverityLevel)] \(.Message)"' 2>/dev/null | head -10
else
    echo "  (Logs not yet ingested - check back in 2-5 minutes)"
    echo ""
    echo "  Expected to see something like:"
    echo "    [2] Injection blocked: sql_injection"
    echo "    [2] Injection blocked: path_traversal"
    echo "    [2] Injection blocked: shell_injection"
fi

echo ""
echo -e "${CYAN}================================================================${NC}"
echo -e "${CYAN}  The Problem: Can You Answer These Questions?${NC}"
echo -e "${CYAN}================================================================${NC}"
echo ""
echo "With basic logging, try answering:"
echo ""
echo -e "  ${RED}?${NC} How many SQL injection attempts in the last hour?"
echo -e "  ${RED}?${NC} Which tools are being targeted most often?"
echo -e "  ${RED}?${NC} Can you correlate this with the APIM caller IP?"
echo -e "  ${RED}?${NC} What's the pattern - is it an automated attack?"
echo ""
echo -e "${RED}You can't - the logs are just unstructured strings!${NC}"
echo ""

echo -e "${CYAN}================================================================${NC}"
echo -e "${CYAN}  What v2 Structured Logging Provides${NC}"
echo -e "${CYAN}================================================================${NC}"
echo ""
echo "Structured logging adds queryable custom dimensions:"
echo ""
echo -e "${GREEN}  {${NC}"
echo -e "${GREEN}    \"event_type\": \"INJECTION_BLOCKED\",${NC}"
echo -e "${GREEN}    \"injection_type\": \"sql_injection\",${NC}"
echo -e "${GREEN}    \"correlation_id\": \"abc-123-xyz\",${NC}"
echo -e "${GREEN}    \"tool_name\": \"search\",${NC}"
echo -e "${GREEN}    \"timestamp_utc\": \"2024-01-15T10:30:00Z\"${NC}"
echo -e "${GREEN}  }${NC}"
echo ""
echo "Now you can:"
echo "  ✓ Query by injection type"
echo "  ✓ Correlate with APIM logs via correlation_id"
echo "  ✓ Build dashboards showing attack patterns"
echo "  ✓ Alert on specific conditions"
echo ""
