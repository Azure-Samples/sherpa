#!/bin/bash
# Waypoint 1.1: Exploit - PII Leakage
# Demonstrates that PII in MCP tool responses leaks through without output sanitization
# Usage: ./1.1-exploit-pii.sh [sherpa|trails|both]
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

TARGET="${1:-both}"
if [[ "$TARGET" != "sherpa" && "$TARGET" != "trails" && "$TARGET" != "both" ]]; then
    echo "Usage: $0 [sherpa|trails|both]"
    exit 1
fi

echo ""
echo "=========================================="
echo "Waypoint 1.1: PII Leakage in MCP Responses"
echo "Target: $TARGET"
echo "=========================================="
echo ""

APIM_URL=$(azd env get-value APIM_GATEWAY_URL)
MCP_APP_CLIENT_ID=$(azd env get-value MCP_APP_CLIENT_ID)
TRAIL_API_URL=$(azd env get-value TRAIL_API_URL)

echo "Getting OAuth token..."
TOKEN=$(az account get-access-token --resource "$MCP_APP_CLIENT_ID" --query accessToken -o tsv 2>/dev/null)

if [ -z "$TOKEN" ]; then
    echo "Failed to get OAuth token. Make sure you're logged in with: az login"
    exit 1
fi

echo "Token acquired successfully"
echo ""

# ============================================
# Test 1: Trail MCP (synthesized)
# ============================================
if [[ "$TARGET" == "trails" || "$TARGET" == "both" ]]; then

echo "Test 1: Trail MCP Server (synthesized)"
echo "======================================"
echo ""
echo "The Trail MCP Server exposes a 'get-permit-holder' tool that returns"
echo "permit holder details including sensitive PII like Social Security Numbers."
echo ""
echo "Without output sanitization, this PII passes through APIM to AI clients."
echo ""

# First show direct REST API response for comparison
echo "Direct REST API Response (bypassing MCP layer):"
echo "------------------------------------------------"
DIRECT_RESPONSE=$(curl -s "$TRAIL_API_URL/permits/TRAIL-2024-001/holder" 2>/dev/null || echo '{"error": "Could not reach API directly"}')
echo "$DIRECT_RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$DIRECT_RESPONSE"
echo ""

# Now call through Trail MCP Server
echo "Through Trail MCP Server (tools/call get-permit-holder):"
echo "---------------------------------------------------------"

# Trail MCP uses client-generated session ID
SESSION_ID="session-$(date +%s)"

# Call the get-permit-holder tool via MCP
MCP_REQUEST='{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "get-permit-holder",
    "arguments": {
      "permitId": "TRAIL-2024-001"
    }
  },
  "id": 1
}'

RESPONSE=$(curl -s --max-time 15 -X POST "$APIM_URL/trails/mcp" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -H "Accept: application/json, text/event-stream" \
  -H "Mcp-Session-Id: $SESSION_ID" \
  -d "$MCP_REQUEST" 2>/dev/null || echo "error")

# Check if we got a response
if [ "$RESPONSE" = "error" ] || [ -z "$RESPONSE" ]; then
    echo "Failed to get response from Trail MCP Server"
    exit 1
fi

# Parse SSE response - look for data lines with JSON-RPC result
if echo "$RESPONSE" | grep -q "^data:"; then
    # Extract JSON from SSE data line (first data line with actual content)
    JSON_DATA=$(echo "$RESPONSE" | grep "^data:" | head -1 | sed 's/^data: *//')
    
    # Pretty print if it's valid JSON
    if echo "$JSON_DATA" | python3 -m json.tool > /dev/null 2>&1; then
        echo "$JSON_DATA" | python3 -m json.tool
    else
        echo "$JSON_DATA"
    fi
else
    echo "$RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$RESPONSE"
fi
echo ""

# Check for PII in response
if echo "$RESPONSE" | grep -qi "ssn\|123-45-6789"; then
    echo "=========================================="
    echo "PII LEAKED THROUGH MCP!"
    echo "=========================================="
    echo ""
    echo "The MCP tool response contains:"
    echo "  - SSN (Social Security Number)"
    echo "  - Email address"
    echo "  - Phone number"
    echo "  - Physical address"
    echo ""
    echo "This violates:"
    echo "  - OWASP MCP-03: Tool Poisoning (data exfiltration)"
    echo "  - GDPR/CCPA compliance requirements"
    echo "  - SOC 2 data protection controls"
fi

echo ""
echo "=========================================="
echo "Why This Matters for MCP"
echo "=========================================="
echo ""
echo "MCP servers aggregate data from backend APIs and expose it as tools."
echo "AI clients call these tools and receive the raw responses."
echo ""
echo "Without output sanitization on the Trail MCP Server:"
echo "  - PII flows directly to AI systems"
echo "  - AI assistants may memorize or expose sensitive data"
echo "  - Compliance requirements are violated"
echo ""
echo "The fix: Apply output sanitization policy to Trail MCP outbound"
echo ""
echo "=========================================="

fi  # end trails test

# ============================================
# Test 2: Sherpa MCP (real proxy)
# ============================================
if [[ "$TARGET" == "sherpa" || "$TARGET" == "both" ]]; then

echo ""
echo "Test 2: Sherpa MCP Server (real proxy)"
echo "======================================"
echo ""
echo "The Sherpa MCP Server exposes a 'get_guide_contact' tool that returns"
echo "guide details including sensitive PII like Social Security Numbers."
echo ""

# Initialize MCP session
echo "Initializing Sherpa MCP session..."
INIT_RESPONSE=$(curl -s -i --max-time 10 -X POST "$APIM_URL/sherpa/mcp" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -H "Accept: application/json, text/event-stream" \
  -d '{"jsonrpc":"2.0","method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}},"id":0}')
SESSION_ID=$(echo "$INIT_RESPONSE" | grep -i "mcp-session-id" | sed 's/.*: *//' | tr -d '\r\n')
echo "Session: $SESSION_ID"
echo ""

echo "Calling get_guide_contact (contains PII):"
echo "------------------------------------------"

SHERPA_RESPONSE=$(curl -s --max-time 15 -X POST "$APIM_URL/sherpa/mcp" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -H "Accept: application/json, text/event-stream" \
  -H "Mcp-Session-Id: $SESSION_ID" \
  -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get_guide_contact","arguments":{"guide_id":"guide-002"}},"id":1}' 2>/dev/null || echo "error")

# Parse SSE response if present
if echo "$SHERPA_RESPONSE" | grep -q "^data:"; then
    JSON_DATA=$(echo "$SHERPA_RESPONSE" | grep "^data:" | head -1 | sed 's/^data: *//')
    if echo "$JSON_DATA" | python3 -m json.tool > /dev/null 2>&1; then
        echo "$JSON_DATA" | python3 -m json.tool
    else
        echo "$JSON_DATA"
    fi
else
    echo "$SHERPA_RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$SHERPA_RESPONSE"
fi
echo ""

# Check for PII in response
if echo "$SHERPA_RESPONSE" | grep -qi "ssn\|123-45-6789\|987-65-4321"; then
    echo "=========================================="
    echo "PII LEAKED THROUGH SHERPA MCP!"
    echo "=========================================="
    echo ""
    echo "The MCP tool response contains:"
    echo "  - SSN (Social Security Number)"
    echo "  - Email address"
    echo "  - Phone number"
    echo "  - Physical address"
    echo ""
fi

fi  # end sherpa test

echo ""
echo "=========================================="
echo "Summary: Why Output Sanitization Matters"
echo "=========================================="
echo ""
echo "MCP servers aggregate data from backend APIs and expose it as tools."
echo "AI clients call these tools and receive the raw responses."
echo ""
echo "Without output sanitization:"
echo "  - PII flows directly to AI systems"
echo "  - AI assistants may memorize or expose sensitive data"
echo "  - Compliance requirements are violated (GDPR/CCPA/SOC2)"
echo ""
echo "The fix: Apply output sanitization policies"
echo "  - sherpa-mcp: Outbound sanitization in MCP policy"
echo "  - trail-mcp:  Outbound sanitization on trail-api (REST)"
echo ""
echo "=========================================="
