#!/bin/bash
# Waypoint 1.1: Exploit - PII Leakage
# Demonstrates that PII in responses leaks through without output sanitization
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

echo ""
echo "=========================================="
echo "Waypoint 1.1: PII Leakage in Responses"
echo "=========================================="
echo ""

APIM_URL=$(azd env get-value APIM_GATEWAY_URL)
MCP_APP_CLIENT_ID=$(azd env get-value MCP_APP_CLIENT_ID)
TRAIL_API_URL=$(azd env get-value TRAIL_API_URL)

echo "Getting OAuth token..."
TOKEN=$(az account get-access-token --resource "$MCP_APP_CLIENT_ID" --query accessToken -o tsv 2>/dev/null)

if [ -z "$TOKEN" ]; then
    echo "Failed to get OAuth token. Make sure you're logged in with: az login"
    exit 1
fi

echo "Token acquired successfully"
echo ""

echo "The Problem: PII Leaks Through APIM"
echo "===================================="
echo ""
echo "The Trail API has an endpoint that returns permit holder details"
echo "including sensitive PII like Social Security Numbers."
echo ""
echo "Without output sanitization, this PII passes through APIM unchanged."
echo ""

echo "Calling /permits/TRAIL-2024-001/holder..."
echo ""

# First try direct API call to show the raw data
echo "Direct API Response (bypassing APIM):"
echo "--------------------------------------"
DIRECT_RESPONSE=$(curl -s "$TRAIL_API_URL/permits/TRAIL-2024-001/holder" 2>/dev/null || echo '{"error": "Could not reach API directly"}')
echo "$DIRECT_RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$DIRECT_RESPONSE"
echo ""

# Now through APIM
echo "Through APIM Gateway (with OAuth):"
echo "----------------------------------"
RESPONSE=$(curl -s -w "\n%{http_code}" -X GET "$APIM_URL/trail/permits/TRAIL-2024-001/holder" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Accept: application/json" 2>/dev/null || echo -e "\n000")

HTTP_CODE=$(echo "$RESPONSE" | tail -1)
BODY=$(echo "$RESPONSE" | sed '$d')

echo "Status: $HTTP_CODE"
echo ""
if [ "$HTTP_CODE" = "200" ]; then
    echo "$BODY" | python3 -m json.tool 2>/dev/null || echo "$BODY"
    echo ""
    
    # Check for PII in response
    if echo "$BODY" | grep -q "ssn"; then
        echo "=========================================="
        echo "PII LEAKED!"
        echo "=========================================="
        echo ""
        echo "The response contains:"
        echo "  - SSN (Social Security Number)"
        echo "  - Email address"
        echo "  - Phone number"
        echo "  - Physical address"
        echo ""
        echo "This violates:"
        echo "  - OWASP MCP-03: Tool Poisoning (data exfiltration)"
        echo "  - GDPR/CCPA compliance requirements"
        echo "  - SOC 2 data protection controls"
    fi
else
    echo "Response: $BODY"
fi

echo ""
echo "=========================================="
echo "Why This Matters"
echo "=========================================="
echo ""
echo "MCP servers often aggregate data from multiple backend systems."
echo "A single API endpoint might return sensitive data that shouldn't"
echo "be exposed to end users or AI systems."
echo ""
echo "Without output sanitization:"
echo "  - PII can leak to unauthorized users"
echo "  - AI systems might memorize or expose secrets"
echo "  - Compliance requirements are violated"
echo ""
echo "=========================================="
echo ""
echo "Next: Deploy the security function"
echo "  ./scripts/1.2-deploy-function.sh"
echo ""
