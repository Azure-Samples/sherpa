<!--
  OAuth callback policy - Returns success/error HTML page
  APIM handles this directly, no backend proxy needed
-->
<policies>
  <inbound>
    <base />
    <choose>
      <when condition="@(context.Request.Url.Query.GetValueOrDefault("error", "") != "")">
        <!-- Error response -->
        <return-response>
          <set-status code="200" reason="OK" />
          <set-header name="Content-Type" exists-action="override">
            <value>text/html</value>
          </set-header>
          <set-body>@{
            var error = context.Request.Url.Query.GetValueOrDefault("error", "Unknown error");
            return $@"<!DOCTYPE html>
<html>
<head><title>Authentication Error</title>
<style>
body {{ font-family: system-ui, sans-serif; margin: 40px; background: #f5f5f5; }}
.container {{ max-width: 500px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
h1 {{ color: #dc3545; }}
.error {{ background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; }}
</style>
</head>
<body>
<div class='container'>
<h1>Authentication Error</h1>
<div class='error'><strong>Error:</strong> {error}</div>
<p>Please try again or contact your administrator.</p>
</div>
</body>
</html>";
          }</set-body>
        </return-response>
      </when>
      <when condition="@(context.Request.Url.Query.GetValueOrDefault("code", "") != "")">
        <!-- Success response -->
        <return-response>
          <set-status code="200" reason="OK" />
          <set-header name="Content-Type" exists-action="override">
            <value>text/html</value>
          </set-header>
          <set-body>@{
            return @"<!DOCTYPE html>
<html>
<head><title>Authentication Successful</title>
<style>
body { font-family: system-ui, sans-serif; margin: 40px; background: #f5f5f5; }
.container { max-width: 500px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
h1 { color: #28a745; }
.success { background: #d4edda; padding: 15px; border-left: 4px solid #28a745; margin: 20px 0; }
</style>
</head>
<body>
<div class='container'>
<h1>Authentication Successful!</h1>
<div class='success'>You have successfully authenticated.</div>
<p><strong>Next steps:</strong></p>
<ul>
<li>You can close this browser window</li>
<li>Return to VS Code and try using the MCP tools</li>
</ul>
</div>
</body>
</html>";
          }</set-body>
        </return-response>
      </when>
      <otherwise>
        <!-- No code or error -->
        <return-response>
          <set-status code="400" reason="Bad Request" />
          <set-header name="Content-Type" exists-action="override">
            <value>text/html</value>
          </set-header>
          <set-body>@{
            return @"<!DOCTYPE html>
<html>
<head><title>Authentication</title></head>
<body>
<h1>No authorization code received</h1>
<p>Please try the authentication process again.</p>
</body>
</html>";
          }</set-body>
        </return-response>
      </otherwise>
    </choose>
  </inbound>
  <backend>
    <base />
  </backend>
  <outbound>
    <base />
  </outbound>
  <on-error>
    <base />
  </on-error>
</policies>
