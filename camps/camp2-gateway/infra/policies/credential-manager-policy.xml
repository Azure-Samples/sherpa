<!--
  Credential Manager policy for secured backend calls
  Gets token on behalf of user for Trail API permits endpoint
-->
<policies>
  <inbound>
    <base />
    <!-- Get token using OAuth2 client credentials flow -->
    <send-request mode="new" response-variable-name="token-response" timeout="20" ignore-error="false">
      <set-url>https://login.microsoftonline.com/{{tenant-id}}/oauth2/v2.0/token</set-url>
      <set-method>POST</set-method>
      <set-header name="Content-Type" exists-action="override">
        <value>application/x-www-form-urlencoded</value>
      </set-header>
      <set-body>@{
        return "client_id={{apim-client-app-id}}&amp;scope=api://{{mcp-app-client-id}}/.default&amp;client_secret={{apim-client-secret}}&amp;grant_type=client_credentials";
      }</set-body>
    </send-request>
    <!-- Extract and forward the access token -->
    <set-variable name="token-json" value="@(((IResponse)context.Variables[&quot;token-response&quot;]).Body.As&lt;JObject&gt;())" />
    <set-header name="X-Forwarded-Authorization" exists-action="override">
      <value>@("Bearer " + (string)((JObject)context.Variables[&quot;token-json&quot;])[&quot;access_token&quot;])</value>
    </set-header>
  </inbound>
  <backend>
    <base />
  </backend>
  <outbound>
    <base />
  </outbound>
  <on-error>
    <base />
  </on-error>
</policies>
