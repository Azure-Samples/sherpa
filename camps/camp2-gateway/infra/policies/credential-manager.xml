<!--
  Credential Manager policy for secured backend calls
  Gets token on behalf of APIM for protected backend operations
-->
<policies>
  <inbound>
    <base />
    <!-- Validate OAuth token -->
    <validate-azure-ad-token tenant-id="{{tenant-id}}" 
                              failed-validation-httpcode="401" 
                              failed-validation-error-message="Unauthorized">
      <audiences>
        <audience>api://{{mcp-app-client-id}}</audience>
      </audiences>
    </validate-azure-ad-token>
    <!-- Rate limiting -->
    <set-variable name="mcp-session-id" value="@(context.Request.Headers.GetValueOrDefault("Mcp-Session-Id", context.Request.Headers.GetValueOrDefault("X-Request-Id", Guid.NewGuid().ToString())))" />
    <rate-limit-by-key calls="10" renewal-period="60" counter-key="@((string)context.Variables["mcp-session-id"])" />
    <!-- Content Safety check -->
    <llm-content-safety backend-id="content-safety-backend">
      <text-content>
        <input>@(context.Request.Body.As<string>(preserveContent: true))</input>
      </text-content>
      <prompt-shields enabled="true" />
    </llm-content-safety>
    <!-- Get backend token using client credentials -->
    <send-request mode="new" response-variable-name="token-response" timeout="20" ignore-error="false">
      <set-url>https://login.microsoftonline.com/{{tenant-id}}/oauth2/v2.0/token</set-url>
      <set-method>POST</set-method>
      <set-header name="Content-Type" exists-action="override">
        <value>application/x-www-form-urlencoded</value>
      </set-header>
      <set-body>@{
        return $"client_id={{{{apim-client-app-id}}}}&amp;scope=api://{{{{mcp-app-client-id}}}}/.default&amp;client_secret={{{{Named Values['apim-client-secret']}}}}&amp;grant_type=client_credentials";
      }</set-body>
    </send-request>
    <!-- Extract and forward the access token to backend -->
    <set-variable name="backend-token" value="@{
      var response = ((IResponse)context.Variables["token-response"]);
      if (response.StatusCode == 200) {
        var body = response.Body.As<JObject>();
        return (string)body["access_token"];
      }
      return null;
    }" />
    <choose>
      <when condition="@(context.Variables.GetValueOrDefault<string>("backend-token") != null)">
        <set-header name="Authorization" exists-action="override">
          <value>@("Bearer " + (string)context.Variables["backend-token"])</value>
        </set-header>
      </when>
    </choose>
  </inbound>
  <backend>
    <forward-request />
  </backend>
  <outbound>
    <base />
  </outbound>
  <on-error>
    <base />
    <choose>
      <when condition="@(context.Response.StatusCode == 401)">
        <return-response>
          <set-status code="401" reason="Unauthorized" />
          <set-header name="WWW-Authenticate" exists-action="override">
            <value>Bearer error="invalid_token", resource_metadata="{{apim-gateway-url}}/.well-known/oauth-protected-resource"</value>
          </set-header>
        </return-response>
      </when>
    </choose>
  </on-error>
</policies>
