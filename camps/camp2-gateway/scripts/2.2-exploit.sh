#!/bin/bash
# Waypoint 2.2: Exploit - No Backend Authentication
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

echo ""
echo "=========================================="
echo "Waypoint 2.2: No Backend Authentication"
echo "=========================================="
echo ""

APIM_URL=$(azd env get-value APIM_GATEWAY_URL)
TRAIL_URL=$(azd env get-value SERVICE_TRAIL_API_URI)

echo "The Problem: Backend Requires Its Own Auth"
echo "-------------------------------------------"
echo ""
echo "The /permits endpoint requires authentication..."
echo ""

echo "Test 1: Call permits through APIM (no backend token)"
RESPONSE=$(curl -s -w "\n%{http_code}" \
    "$APIM_URL/trails/permits" \
    -H "Content-Type: application/json" 2>/dev/null || echo -e "\n000")
HTTP_CODE=$(echo "$RESPONSE" | tail -1)
BODY=$(echo "$RESPONSE" | head -n -1)
echo "  Result: $HTTP_CODE"
if [ "$HTTP_CODE" = "401" ]; then
    echo "  Body: $BODY"
fi

echo ""
echo "Test 2: Direct backend call (also fails)"
RESPONSE=$(curl -s -w "\n%{http_code}" \
    "$TRAIL_URL/permits" \
    -H "Content-Type: application/json" 2>/dev/null || echo -e "\n000")
HTTP_CODE=$(echo "$RESPONSE" | tail -1)
echo "  Result: $HTTP_CODE"

echo ""
echo "Issues identified:"
echo "  - Backend requires separate OAuth token"
echo "  - Client doesn't have backend credentials"
echo "  - Developers might hardcode secrets (bad!)"
echo "  - No secure way to call protected backends"
echo ""
echo "=========================================="
echo ""
echo "Next: Apply Credential Manager"
echo "  ./scripts/2.2-fix.sh"
echo ""
