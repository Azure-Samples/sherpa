#!/bin/bash
# Waypoint 3.1: Exploit - Direct Backend Access
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

echo ""
echo "=========================================="
echo "Waypoint 3.1: Direct Backend Access"
echo "=========================================="
echo ""

APIM_URL=$(azd env get-value APIM_GATEWAY_URL)
SHERPA_URL=$(azd env get-value SHERPA_SERVER_URL)
TRAIL_URL=$(azd env get-value TRAIL_API_URL)

echo "The Problem: Backends Are Publicly Accessible"
echo "----------------------------------------------"
echo ""
echo "All our security controls can be bypassed..."
echo ""

echo "Test 1: Direct call to Sherpa (bypasses OAuth)"
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
    "$SHERPA_URL/mcp" 2>/dev/null || echo "000")
echo "  Direct: $SHERPA_URL/mcp"
echo "  Result: $HTTP_STATUS (any 2xx/4xx proves public reachability)"

echo ""
echo "Test 2: Direct call to Trail API (bypasses rate limiting)"
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
    "$TRAIL_URL/" 2>/dev/null || echo "000")
echo "  Direct: $TRAIL_URL/"
echo "  Result: $HTTP_STATUS"

echo ""
echo "Issues identified:"
echo "  - Direct access bypasses OAuth"
echo "  - Direct access bypasses rate limiting"
echo "  - Direct access bypasses content safety"
echo ""
echo "=========================================="
echo ""
echo "Next: Apply IP restrictions"
echo "  ./scripts/3.1-fix.sh"
echo ""
