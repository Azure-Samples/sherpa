#!/bin/bash
# Waypoint 1.1: Exploit - No Authentication
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

echo ""
echo "=========================================="
echo "Waypoint 1.1: No Authentication"
echo "=========================================="
echo ""

APIM_URL=$(azd env get-value APIM_GATEWAY_URL)

echo "The Problem: Anyone Can Access"
echo "-------------------------------"
echo ""

echo "Anonymous user makes a request (no credentials):"
RESPONSE=$(curl -s -m 5 -w "\n%{http_code}" -H "Accept: text/event-stream" "$APIM_URL/sherpa/mcp" 2>/dev/null || echo -e "\n000")
HTTP_CODE=$(echo "$RESPONSE" | tail -1)
echo "  Status: $HTTP_CODE"
if [ "$HTTP_CODE" = "200" ]; then
  echo "  ✅ Request succeeded (no authentication required!)"
else
  echo "  Response: $HTTP_CODE"
fi
echo ""

echo "Attacker from anywhere in the world:"
RESPONSE=$(curl -s -m 5 -w "\n%{http_code}" -H "Accept: text/event-stream" "$APIM_URL/sherpa/mcp" 2>/dev/null || echo -e "\n000")
HTTP_CODE=$(echo "$RESPONSE" | tail -1)
echo "  Status: $HTTP_CODE"
if [ "$HTTP_CODE" = "200" ]; then
  echo "  ✅ Request succeeded (completely open!)"
else
  echo "  Response: $HTTP_CODE"
fi
echo ""

echo "Bot scraping the internet:"
RESPONSE=$(curl -s -m 5 -w "\n%{http_code}" -H "Accept: text/event-stream" "$APIM_URL/sherpa/mcp" 2>/dev/null || echo -e "\n000")
HTTP_CODE=$(echo "$RESPONSE" | tail -1)
echo "  Status: $HTTP_CODE"
if [ "$HTTP_CODE" = "200" ]; then
  echo "  ✅ Request succeeded (exposed to the internet!)"
else
  echo "  Response: $HTTP_CODE"
fi
echo ""

echo "Issues identified:"
echo "  - No authentication required"
echo "  - No way to identify users"
echo "  - No access control whatsoever"
echo "  - Anyone on the internet can call your MCP tools"
echo "  - No audit trail of who did what"
echo ""
echo "=========================================="
echo ""
echo "Next: Apply OAuth for user authentication"
echo "  ./scripts/1.1-fix.sh"
echo ""
