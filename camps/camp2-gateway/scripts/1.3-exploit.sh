#!/bin/bash
# Waypoint 1.3: Exploit - No Rate Limiting
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

echo ""
echo "=========================================="
echo "Waypoint 1.3: No Rate Limiting"
echo "=========================================="
echo ""

APIM_URL=$(azd env get-value APIM_GATEWAY_URL)
SUB_KEY=$(azd env get-value TRAIL_SUBSCRIPTION_KEY)

echo "The Problem: Unlimited Requests"
echo "--------------------------------"
echo ""
echo "Even with authentication, a single user (or compromised account)"
echo "can overwhelm your backend with unlimited requests."
echo ""

echo "Sending 20 rapid requests to Trail API..."
SUCCESS_COUNT=0
for i in {1..20}; do
    HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$APIM_URL/trailapi/trails" \
        -H "Ocp-Apim-Subscription-Key: $SUB_KEY" 2>/dev/null || echo "000")
    
    if [ "$HTTP_STATUS" != "429" ]; then
        echo "  Request $i: $HTTP_STATUS (not rate limited)"
        ((SUCCESS_COUNT++))
    else
        echo "  Request $i: 429 (rate limited)"
    fi
done

echo ""
echo "Results:"
echo "  Requests that reached backend: $SUCCESS_COUNT"
echo ""

if [ "$SUCCESS_COUNT" -eq 20 ]; then
    echo "Issues identified:"
    echo "  ❌ All 20 requests reached the backend"
    echo "  ❌ No throttling protection"
    echo "  ❌ Single user can monopolize resources"
    echo "  ❌ Cost explosion risk (every request = $$)"
    echo "  ❌ No protection against runaway loops"
fi

echo ""
echo "=========================================="
echo ""
echo "Next: Apply rate limiting"
echo "  ./scripts/1.3-fix.sh"
echo ""
