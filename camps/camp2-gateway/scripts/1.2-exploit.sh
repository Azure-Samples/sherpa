#!/bin/bash
# Waypoint 1.2: Exploit - Subscription Key Limitations
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

echo ""
echo "=========================================="
echo "Waypoint 1.2: Subscription Key Limitations"
echo "=========================================="
echo ""

APIM_URL=$(azd env get-value APIM_GATEWAY_URL)
SUB_KEY=$(azd env get-value TRAIL_API_SUBSCRIPTION_KEY)

echo "The Problem with Subscription Keys"
echo "-----------------------------------"
echo ""
echo "Subscription Key: ${SUB_KEY:0:8}...${SUB_KEY: -4}"
echo ""

echo "User A (Alice) makes a request:"
RESPONSE=$(curl -s -w "\n%{http_code}" "$APIM_URL/trails" \
    -H "Ocp-Apim-Subscription-Key: $SUB_KEY" 2>/dev/null || echo -e "\n000")
HTTP_CODE=$(echo "$RESPONSE" | tail -1)
echo "  Status: $HTTP_CODE"

echo ""
echo "User B (Bob) uses the SAME key (shared via Slack):"
RESPONSE=$(curl -s -w "\n%{http_code}" "$APIM_URL/trails" \
    -H "Ocp-Apim-Subscription-Key: $SUB_KEY" 2>/dev/null || echo -e "\n000")
HTTP_CODE=$(echo "$RESPONSE" | tail -1)
echo "  Status: $HTTP_CODE"

echo ""
echo "User C (Attacker) finds the key in a GitHub repo:"
RESPONSE=$(curl -s -w "\n%{http_code}" "$APIM_URL/trails" \
    -H "Ocp-Apim-Subscription-Key: $SUB_KEY" 2>/dev/null || echo -e "\n000")
HTTP_CODE=$(echo "$RESPONSE" | tail -1)
echo "  Status: $HTTP_CODE"

echo ""
echo "Issues identified:"
echo "  ❌ No way to identify individual users"
echo "  ❌ Can't revoke Bob's access without affecting Alice"
echo "  ❌ Keys are easily shared and leaked"
echo "  ❌ No audit trail of who did what"
echo "  ❌ All-or-nothing access (can't grant different permissions)"
echo ""
echo "=========================================="
echo ""
echo "Next: Add OAuth for proper user identity"
echo "  ./scripts/1.2-fix.sh"
echo ""
