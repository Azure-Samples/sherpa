# Azure AI Foundry + APIM + MCP OAuth Setup Guide

This document captures the learnings from configuring Azure AI Foundry to connect to an MCP server through Azure API Management with OAuth authentication.

## Summary

Connecting Foundry to an MCP server via APIM with OAuth Identity Passthrough required several configuration changes that aren't immediately obvious.

## Prerequisites

- Azure API Management instance with MCP API configured
- Entra ID App Registration for the MCP server
- OAuth validation policy on APIM
- Azure AI Foundry project with an agent

## Key Configuration Changes Required

### 1. APIM Policy: Accept Header Injection

**Problem:** MCP Streamable HTTP requires clients to send `Accept: application/json, text/event-stream`. Foundry doesn't send this header, causing `406 Not Acceptable` errors.

**Solution:** Add header injection in the APIM inbound policy:

```xml
<inbound>
  <!-- ... other policies ... -->
  <set-header name="Accept" exists-action="override">
    <value>application/json, text/event-stream</value>
  </set-header>
</inbound>
```

### 2. App Registration: Enable Public Client Flow

**Problem:** Foundry uses PKCE (Proof Key for Code Exchange) flow without a client secret. The app must be configured to allow this.

**Solution:** Enable public client flow on the app registration:

```bash
az ad app update --id "<app-id>" --set "isFallbackPublicClient=true"
```

In Azure Portal: **App Registration** → **Authentication** → **Allow public client flows** → **Yes**

### 3. App Registration: Correct Redirect URI

**Problem:** Foundry uses a specific redirect URI pattern for OAuth callbacks that must be registered.

**Solution:** Add the Foundry redirect URI:

```bash
az ad app update --id "<app-id>" --web-redirect-uris \
  "https://global.consent.azure-apim.net/redirect/<unique-id>-<tool-name>"
```

**Important:** The redirect URI is generated by Foundry and follows the pattern:
- `https://global.consent.azure-apim.net/redirect/{guid}-{tool-name-from-foundry}`

The `{tool-name-from-foundry}` comes from what you name the MCP connection in Foundry's UI (with spaces replaced by hyphens, lowercased).

To find the exact redirect URI needed:
1. Attempt to sign in from Foundry
2. Check the error message - it will show the redirect URI being requested
3. Add that exact URI to the app registration

### 4. APIM Policy: Proper 401 Response with WWW-Authenticate

**Problem:** OAuth clients need the `WWW-Authenticate` header with PRM (Protected Resource Metadata) URL to discover authentication requirements.

**Solution:** Add on-error handling for 401 responses:

```xml
<on-error>
  <base />
  <choose>
    <when condition="@(context.Response.StatusCode == 401)">
      <return-response>
        <set-status code="401" reason="Unauthorized" />
        <set-header name="WWW-Authenticate" exists-action="override">
          <value>Bearer error="invalid_token", resource_metadata="https://{apim-name}.azure-api.net/{api-path}/.well-known/oauth-protected-resource"</value>
        </set-header>
        <set-header name="Content-Type" exists-action="override">
          <value>application/json</value>
        </set-header>
        <set-body>{"error":"unauthorized","message":"Valid OAuth token required","resource_metadata":"https://{apim-name}.azure-api.net/{api-path}/.well-known/oauth-protected-resource"}</set-body>
      </return-response>
    </when>
  </choose>
</on-error>
```

## Complete APIM Policy Template

```xml
<policies>
  <inbound>
    <base />
    <!-- Validate OAuth token -->
    <validate-azure-ad-token tenant-id="{tenant-id}" failed-validation-httpcode="401" failed-validation-error-message="Unauthorized">
      <audiences>
        <audience>{mcp-app-client-id}</audience>
      </audiences>
    </validate-azure-ad-token>
    <!-- Required for MCP Streamable HTTP -->
    <set-header name="Accept" exists-action="override">
      <value>application/json, text/event-stream</value>
    </set-header>
    <!-- Rate limiting -->
    <set-variable name="mcp-session-id" value="@(context.Request.Headers.GetValueOrDefault(&quot;Mcp-Session-Id&quot;, Guid.NewGuid().ToString()))" />
    <rate-limit-by-key calls="100" renewal-period="60" counter-key="@((string)context.Variables[&quot;mcp-session-id&quot;])" />
    <!-- Content Safety (optional) -->
    <llm-content-safety backend-id="content-safety-backend" shield-prompt="true">
      <categories output-type="EightSeverityLevels">
        <category name="Hate" threshold="4" />
        <category name="Violence" threshold="4" />
        <category name="Sexual" threshold="4" />
        <category name="SelfHarm" threshold="4" />
      </categories>
    </llm-content-safety>
  </inbound>
  <backend>
    <forward-request />
  </backend>
  <outbound>
    <base />
  </outbound>
  <on-error>
    <base />
    <choose>
      <when condition="@(context.Response.StatusCode == 401)">
        <return-response>
          <set-status code="401" reason="Unauthorized" />
          <set-header name="WWW-Authenticate" exists-action="override">
            <value>Bearer error="invalid_token", resource_metadata="https://{apim-gateway-url}/{api-path}/.well-known/oauth-protected-resource"</value>
          </set-header>
          <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
          </set-header>
          <set-body>{"error":"unauthorized","message":"Valid OAuth token required","resource_metadata":"https://{apim-gateway-url}/{api-path}/.well-known/oauth-protected-resource"}</set-body>
        </return-response>
      </when>
      <when condition="@(context.Response.StatusCode == 429)">
        <return-response>
          <set-status code="429" reason="Too Many Requests" />
          <set-header name="Retry-After" exists-action="override">
            <value>60</value>
          </set-header>
        </return-response>
      </when>
      <when condition="@(context.LastError.Source == &quot;llm-content-safety&quot;)">
        <return-response>
          <set-status code="400" reason="Bad Request" />
          <set-body>{"error":"content_blocked","message":"Request blocked by content safety policy"}</set-body>
        </return-response>
      </when>
    </choose>
  </on-error>
</policies>
```

## Foundry MCP Connection Settings

| Field | Value |
|-------|-------|
| **Name** | Your tool name (e.g., `Sherpa-MCP`) |
| **Remote MCP Server endpoint** | `https://{apim-name}.azure-api.net/{api-path}` |
| **Authentication** | OAuth Identity Passthrough |
| **Client ID** | `{mcp-app-client-id}` |
| **Client secret** | *(leave empty - using PKCE)* |
| **Token URL** | `https://login.microsoftonline.com/{tenant-id}/oauth2/v2.0/token` |
| **Auth URL** | `https://login.microsoftonline.com/{tenant-id}/oauth2/v2.0/authorize` |
| **Refresh URL** | `https://login.microsoftonline.com/{tenant-id}/oauth2/v2.0/token` |
| **Scopes** | `{mcp-app-client-id}/user_impersonate` |

## Required App Registration Settings

### Redirect URIs (Web)
```
https://global.consent.azure-apim.net/redirect/{guid}-{tool-name}
```

### Public Client Settings
- **Allow public client flows:** Yes
- **isFallbackPublicClient:** true

### API Permissions
- The app should expose a scope (e.g., `user_impersonate`)
- No additional API permissions required for basic MCP operation

## Debugging Tips

### No requests reaching APIM
- Check browser Network tab for requests to your APIM domain
- Foundry uses lazy connection - tools are only discovered when you try to use them
- Try asking the agent explicitly: "Use the get_weather tool to check conditions"

### 401 Unauthorized
- Token audience mismatch - ensure APIM validates the correct audience (`{app-id}`)
- Check that the scope format is `{app-id}/scope_name` (not `api://{app-id}/scope_name`)

### 406 Not Acceptable
- MCP server requires `Accept: application/json, text/event-stream`
- Add the Accept header injection to APIM policy

### Redirect URI Mismatch
- The redirect URI in Foundry's OAuth request must exactly match one registered in the app
- Check the error message for the exact URI being requested

### Sign-in loops
- Clear browser cookies for `ai.azure.com` and `login.microsoftonline.com`
- Delete and recreate the MCP connection in Foundry

### Tools not discovered
- Check Container App logs for incoming requests
- Verify the MCP server responds to `tools/list` method
- Test directly with curl to isolate APIM vs MCP issues

## Comparison: VS Code vs Foundry

| Aspect | VS Code | Foundry |
|--------|---------|---------|
| Auth Flow | Client Credentials (machine-to-machine) | OAuth Identity Passthrough (user delegation) |
| Client Secret | Required in mcp.json | Not used (PKCE) |
| Token Audience | `{app-id}` | `{app-id}` |
| Accept Header | Sent correctly | Missing - needs APIM injection |
| Redirect URI | Not needed | Required in app registration |

## References

- [RFC 9728 - OAuth Protected Resource Metadata](https://datatracker.ietf.org/doc/html/rfc9728)
- [MCP Streamable HTTP Specification](https://modelcontextprotocol.io/docs/concepts/transports#streamable-http)
- [Azure APIM validate-azure-ad-token Policy](https://learn.microsoft.com/en-us/azure/api-management/validate-azure-ad-token-policy)
