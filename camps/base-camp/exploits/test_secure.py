"""
Base Camp Secure Server Testing Script

This script validates that the security fixes work correctly using the MCP SDK.

Prerequisites:
1. Start the secure server in a separate terminal:
   cd camps/base-camp/secure-server
   uv run --project .. python -m src.server

2. Run this test:
   cd camps/base-camp/exploits
   uv run --project .. python test_secure.py
"""

import asyncio
import json
from contextlib import asynccontextmanager
from fastmcp.client import Client
from fastmcp.client.auth import BearerAuth


# Server configuration
SERVER_URL = "http://localhost:8001/mcp"
VALID_TOKEN = "workshop_demo_token_12345"


@asynccontextmanager
async def create_mcp_client(auth_token=None):
    """Create an MCP client connection to the secure server."""
    # Use BearerAuth if token is provided
    auth = BearerAuth(auth_token) if auth_token else None
    
    async with Client(SERVER_URL, auth=auth) as client:
        yield client


async def test_authenticated_access():
    """Test that authenticated access works and retrieve data."""
    print("\nüìã Test 1: Authenticated Access")
    print("   Expected: Should succeed with valid token")
    
    try:
        async with create_mcp_client(auth_token=VALID_TOKEN) as client:
            # List available tools
            tools = await client.list_tools()
            
            if tools and len(tools) > 0:
                print(f"   ‚úÖ Connected: Listed {len(tools)} tool(s)")
                
                # Try calling the get_user_info tool
                result = await client.call_tool("get_user_info", {"user_id": "user_001"})
                
                if result:
                    print(f"   ‚úÖ Tool Call: Successfully retrieved own data")
                    print(f"   üîí Security Fix: Bearer token authentication enforced")
                    
                    # Display the comprehensive retrieved data
                    if result.content:
                        for content_item in result.content:
                            if hasattr(content_item, 'text'):
                                try:
                                    data = json.loads(content_item.text)
                                    print(f"\n   üìä Retrieved User Information:")
                                    print(f"      User ID: {data.get('user_id', 'N/A')}")
                                    print(f"      Name: {data.get('name', 'N/A')}")
                                    print(f"      Email: {data.get('email', 'N/A')}")
                                    print(f"      SSN: {data.get('ssn', 'N/A')}")
                                    print(f"      Account Balance: ${data.get('account_balance', 0):,.2f}")
                                    print(f"      Authenticated As: user_001 (Alice Johnson)\n")
                                except Exception as parse_error:
                                    print(f"   ‚ö†Ô∏è  Could not parse response: {parse_error}")
                    
                    return True
                else:
                    print(f"   ‚ùå Failed: Tool call returned error")
                    return False
            else:
                print(f"   ‚ùå Failed: No tools available")
                return False
                
    except ExceptionGroup as eg:
        # Extract actual errors from ExceptionGroup
        errors = eg.exceptions if hasattr(eg, 'exceptions') else [eg]
        for err in errors:
            print(f"   ‚ùå Failed: {type(err).__name__}: {str(err)[:150]}")
        return False
    except Exception as e:
        print(f"   ‚ùå Failed: {type(e).__name__}: {str(e)[:100]}")
        return False


async def test_unauthenticated_access():
    """Test that unauthenticated access is rejected."""
    print("\nüìã Test 2: Unauthenticated Access")
    print("   Expected: Should reject requests without Bearer token")
    
    try:
        async with create_mcp_client(auth_token=None) as session:
            # Try to list tools without auth
            tools = await session.list_tools()
            print(f"   ‚ùå SECURITY BREACH: Unauthenticated access succeeded!")
            return False
            
    except ExceptionGroup as eg:
        # We expect this to fail - extract actual error
        errors = eg.exceptions if hasattr(eg, 'exceptions') else [eg]
        error_msg = str(errors[0]).lower() if errors else str(eg).lower()
        if "401" in error_msg or "403" in error_msg or "unauthorized" in error_msg or "forbidden" in error_msg:
            print(f"   ‚úÖ Correctly Rejected: Authentication required")
            print(f"   üîí Security Fix: Missing authentication token prevented access")
            print(f"   üìù Server Response: {str(errors[0])[:100]}")
            return True
        else:
            print(f"   ‚úÖ Rejected: {error_msg[:80]}")
            return True  # Still rejected, counts as working
    except Exception as e:
        # We expect this to fail
        error_msg = str(e).lower()
        if "401" in error_msg or "403" in error_msg or "unauthorized" in error_msg or "forbidden" in error_msg:
            print(f"   ‚úÖ Correctly Rejected: Authentication required")
            print(f"   üîí Security Fix: Missing authentication token prevented access")
            print(f"   üìù Server Response: {str(e)[:100]}")
            return True
        else:
            print(f"   ‚úÖ Rejected: {str(e)[:80]}")
            return True  # Still rejected, counts as working


async def test_invalid_token():
    """Test that invalid tokens are rejected."""
    print("\nüìã Test 3: Invalid Token")
    print("   Expected: Should reject requests with invalid Bearer token")
    
    try:
        async with create_mcp_client(auth_token="invalid_token_xxx") as session:
            # Try to list tools with invalid token
            tools = await session.list_tools()
            print(f"   ‚ùå SECURITY BREACH: Invalid token was accepted!")
            return False
            
    except ExceptionGroup as eg:
        # We expect this to fail - extract actual error
        errors = eg.exceptions if hasattr(eg, 'exceptions') else [eg]
        error_msg = str(errors[0]).lower() if errors else str(eg).lower()
        if "401" in error_msg or "403" in error_msg or "unauthorized" in error_msg or "forbidden" in error_msg:
            print(f"   ‚úÖ Correctly Rejected: Invalid token denied")
            print(f"   üîí Security Fix: Token validation prevents unauthorized access")
            print(f"   üìù Server Response: {str(errors[0])[:100]}")
            return True
        else:
            print(f"   ‚úÖ Rejected: {error_msg[:80]}")
            return True  # Still rejected, counts as working
    except Exception as e:
        # We expect this to fail
        error_msg = str(e).lower()
        if "401" in error_msg or "403" in error_msg or "unauthorized" in error_msg or "forbidden" in error_msg:
            print(f"   ‚úÖ Correctly Rejected: Invalid token denied")
            print(f"   üîí Security Fix: Token validation prevents unauthorized access")
            print(f"   üìù Server Response: {str(e)[:100]}")
            return True
        else:
            print(f"   ‚úÖ Rejected: {str(e)[:80]}")
            return True  # Still rejected, counts as working


async def test_authorization_check():
    """Test that users cannot access other users' data (authorization)."""
    print("\nüìã Test 4: Authorization Check")
    print("   Expected: Should prevent user_001 from accessing user_002 data")
    
    try:
        async with create_mcp_client(auth_token=VALID_TOKEN) as session:
            # Authenticated as user_001, try to access user_002's data
            result = await session.call_tool("get_user_info", {"user_id": "user_002"})
            
            if result.isError:
                error_msg = str(result.content)
                if "Forbidden" in error_msg or "cannot access" in error_msg:
                    print(f"   ‚úÖ Correctly Blocked: Cannot access user_002's data")
                    print(f"   üîí Security Fix: Authorization enforces user data isolation")
                    print(f"   üìù Access Denied: Authenticated user_001 cannot view user_002")
                    return True
                else:
                    print(f"   ‚ö†Ô∏è  Blocked but unexpected message: {error_msg[:80]}")
                    return True  # Still blocked
            else:
                print(f"   ‚ùå AUTHORIZATION BREACH: Accessed other user's data!")
                return False
                
    except ExceptionGroup as eg:
        # Extract actual errors from ExceptionGroup
        errors = eg.exceptions if hasattr(eg, 'exceptions') else [eg]
        error_msg = str(errors[0]) if errors else str(eg)
        if "Forbidden" in error_msg or "cannot access" in error_msg:
            print(f"   ‚úÖ Correctly Blocked: Authorization check raised exception")
            print(f"   üîí Security Fix: Users can only access their own data")
            print(f"   üìù Access Denied: user_001 cannot access user_002")
            return True
        else:
            print(f"   ‚ùå Failed: Unexpected error: {error_msg[:150]}")
            return False
    except Exception as e:
        error_msg = str(e)
        if "Forbidden" in error_msg or "cannot access" in error_msg:
            print(f"   ‚úÖ Correctly Blocked: Authorization check raised exception")
            print(f"   üîí Security Fix: Users can only access their own data")
            print(f"   üìù Access Denied: user_001 cannot access user_002")
            return True
        else:
            print(f"   ‚ùå Failed: Unexpected error: {str(e)[:100]}")
            return False


async def test_resource_access():
    """Test resource access with authentication."""
    print("\nüìã Test 5: Resource Access")
    print("   Expected: Should read own resource with valid authentication")
    
    try:
        async with create_mcp_client(auth_token=VALID_TOKEN) as client:
            # Read user_001 resource (own data)
            result = await client.read_resource("user://user_001")
            
            if result and len(result) > 0:
                # FastMCP Client returns a list of resources
                content = result[0].text if hasattr(result[0], 'text') else str(result[0])
                if "SECURE ACCESS" in content or "Alice" in content:
                    print(f"   ‚úÖ Successfully Read: Own resource accessed")
                    print(f"   üîí Security Fix: Authentication verified before resource access")
                    print(f"   üìù Resource URI: user://user_001")
                    if "SECURE ACCESS" in content:
                        print(f"   ‚úÖ Confirmation: Secure access verification in response")
                    return True
                else:
                    print(f"   ‚ö†Ô∏è  Read resource but unexpected content")
                    return False
            else:
                print(f"   ‚ùå Failed: Could not read resource")
                return False
                
    except ExceptionGroup as eg:
        # Extract actual errors from ExceptionGroup
        errors = eg.exceptions if hasattr(eg, 'exceptions') else [eg]
        for err in errors:
            print(f"   ‚ùå Failed: {type(err).__name__}: {str(err)[:150]}")
        return False
    except Exception as e:
        print(f"   ‚ùå Failed: {type(e).__name__}: {str(e)[:100]}")
        return False


async def run_all_tests():
    """Run all security validation tests."""
    
    print("=" * 70)
    print("  üîí BASE CAMP SECURE SERVER - SECURITY VALIDATION")
    print("=" * 70)
    print()
    print("Testing security fixes using MCP SDK")
    print(f"Server: {SERVER_URL}")
    print()
    print("=" * 70)
    
    results = []
    
    # Run tests
    results.append(await test_authenticated_access())
    results.append(await test_unauthenticated_access())
    results.append(await test_invalid_token())
    results.append(await test_authorization_check())
    results.append(await test_resource_access())
    
    # Summary
    print("\n" + "=" * 70)
    print("  üìä SECURITY TEST SUMMARY")
    print("=" * 70)
    
    passed = sum(1 for r in results if r)
    total = len(results)
    
    print(f"\nTests Passed: {passed}/{total}")
    
    if passed == total:
        print("\nüéâ SUCCESS! All security fixes validated!")
        print("\nüîí Security Improvements Confirmed:")
        print("   ‚úÖ Authentication - Bearer token required for all API access")
        print("   ‚úÖ Authorization - Users can only access their own data")
        print("   ‚úÖ Token Validation - Invalid tokens are rejected")
        print("   ‚úÖ Unauthenticated Access - Blocked by default")
        print("   ‚úÖ Resource Protection - Authentication required for all resources")
        print("\n‚ö†Ô∏è  WORKSHOP NOTE: This uses simple bearer tokens for demonstration.")
        print("   This is NOT production-ready security!")
        print("   See README Phase 5 and Camp 1 for production implementations:")
        print("   ‚Ä¢ OAuth 2.1 / OpenID Connect")
        print("   ‚Ä¢ Azure Entra ID integration")
        print("   ‚Ä¢ Azure Key Vault for secrets")
        print("   ‚Ä¢ Role-Based Access Control (RBAC)")
    else:
        print(f"\n‚ùå FAILED: {total - passed} test(s) failed")
        print("\nüîç Troubleshooting:")
        print("  ‚Ä¢ Is the secure server running on port 8001?")
        print("  ‚Ä¢ Start with: cd secure-server && uv run server")
        print("  ‚Ä¢ Check .env file has AUTH_TOKEN configured")
        print("  ‚Ä¢ Review error messages above for specific issues")
    
    print("\n" + "=" * 70 + "\n")
    
    return passed == total


if __name__ == "__main__":
    try:
        success = asyncio.run(run_all_tests())
        exit(0 if success else 1)
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  Tests interrupted by user")
        exit(1)
    except Exception as e:
        print(f"\n\n‚ùå Fatal error: {e}")
        import traceback
        traceback.print_exc()
        exit(1)
